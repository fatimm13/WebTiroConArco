<html>
	<head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">

		<title>Torneo</title>
        <script>
            var nombre = getQuery("nombre");
            var tipo = getQuery("tipo");
            var edad = getQuery("edad");
            var rondas = getQuery("rondas");

            var usuario = new Persona(nombre,0,0,0);

            var participantes = ["Magdalena","Francisco","Emilia","Pedro"]
            var puntuaciones = new Array();

            var rondaActual = 1;
            var tiroRonda = 0;

            function Persona(nombre, puntuacion, nueves, dieces){
                this.nombre = nombre;
                this.puntuacion = puntuacion;
                this.nueves = nueves;
                this.dieces = dieces;
            }

            function comparePersona(a,b) {
                let i = a.puntuacion-b.puntuacion;

                if(i==0){
                    i = a.dieces - b.dieces;
                    if(i==0){
                        i=a.nueves - b.nueves;
                    }
                }

                return -i;
            };

            function getQuery(q) {
                return (window.location.search.match(new RegExp('[?&]' + q + '=([^&]+)')) || [, null])[1];
            }

            function cargaNombre(){
                document.body.innerHTML=nombre;
            }

            function load(){
                

                for(var i = 0;i<participantes.length;i++){

                    puntuaciones.push(new Persona(participantes[i],0,0,0));
                }

                puntuaciones.push(usuario);

                puntuaciones.sort(comparePersona);
                cargarTabla();
                
                inicializarTextArea();
                
            }

            function inicializarTextArea(){
                let ta = document.getElementById("listaPuntuaciones");
                let e = edad.charAt(0).toUpperCase() + edad.slice(1);
                let t = tipo.charAt(0).toUpperCase() + tipo.slice(1);
                ta.innerHTML = "Jugador:"+nombre+"\n" + "Categoría: "+e+"\n"+"Modalidad: "+t+"\n";

                ta.innerHTML += "__________________________\n";
                
            }

            function actualizarTextArea(valor){
                let ta = document.getElementById("listaPuntuaciones");

                tiroRonda++;
                let y = 1;

                if(rondas==12){
                    y = 6;
                }else if(rondas==20){
                    y = 3;
                }

                var r = tiroRonda % y;
                rondaActual += (tiroRonda - r) / y;
                

                if(tiroRonda==1){
                    ta.innerHTML += "Ronda "+rondaActual+"\n";
                    ta.innerHTML += "__________________________\n";
                }

                ta.innerHTML += "Tiro "+tiroRonda+": "+valor+" puntos. \n";

                if(r==0){
                    ta.innerHTML += "__________________________\n";
                }

                if(rondaActual>rondas){
                    ta.innerHTML += "Fin del torneo.\n";
                    ta.innerHTML += "Has quedado en el puesto "+posicion();
                    document.getElementById("boton").disabled = true;
                }
                tiroRonda = r;
                ta.scrollTop = ta.scrollHeight;
            }
            function posicion(){
                var i = 0;
                while(i<puntuaciones.length && usuario!==puntuaciones[i]){
                    i++;
                }
                return i+1;
            }
            function borrarTabla(){
                let table = document.getElementById("tabla");
                let n = table.rows.length;
                for(var i = 1; i<n;i++){
                    table.deleteRow(1);
                }
                var r =document.createElement('TR');
                table.tBodies[0].appendChild(r);
            }

            function cargarTabla(){
                let table = document.getElementById("tabla");
                for(var i = 1;i<=puntuaciones.length;i++){
                    let row = table.insertRow(i);
                    row.insertCell(0).innerHTML = i;
                    row.insertCell(1).innerHTML = puntuaciones[i-1].nombre;
                    row.insertCell(2).innerHTML = puntuaciones[i-1].puntuacion;
                    if (i == 1) {
                        row.classList.add("table-warning");
                        row.classList.remove("table-striped");
                    } else if (i == 2) {
                        row.classList.add("table-danger");
                        row.classList.remove("table-striped");
                    } else if (i == 3) {
                        row.classList.add("table-info");
                        row.classList.remove("table-striped");
                    }
                    if (puntuaciones[i-1] === usuario) {
                        row.classList.add("fw-bold");
                    }
                }
            }

            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min)) + min;
            }

            function incluirPuntuacion(){
                let valor = parseInt(document.getElementById("puntuacion").value,10);
                if(valor>=0 && valor<=10){

                    for(var i = 0;i<puntuaciones.length;i++){
                        let n = getRandomInt(0,10);

                        if(puntuaciones[i]===usuario){
                            n = valor;
                            
                        }

                        if(n==10){
                            puntuaciones[i].dieces += 1;
                        }else if(n==9){
                            puntuaciones[i].nueves += 1;
                        }

                        puntuaciones[i].puntuacion += n;
                        
                    }

                    puntuaciones.sort(comparePersona);
                    borrarTabla();
                    cargarTabla();
                    actualizarTextArea(valor);
                    document.getElementById("nueves").innerHTML=usuario.nueves;
                    document.getElementById("dieces").innerHTML=usuario.dieces;
                    document.getElementById("total").innerHTML=usuario.puntuacion;
                }
                
            }

            window.onload = load;
        </script>
	</head>
	<body>

        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="index.html">
                    <img src="diana.png" alt="Imagen de una diana" width="30" height="30" class="d-inline-block align-text-top">
                    Tiro con arco
                </a>
            </div>
        </nav>

        <div class="table-responsive" style="padding: 2%;">
            <table id = "tabla" class="table table-striped">
                <thead class="table-dark">
                    <tr>
                        <th scope="col">Puesto</th>
                        <th scope="col">Nombre</th>
                        <th scope="col">Puntuaciones</th>
                    </tr>
                </thead>
                <tbody class="table-light">
                    <tr></tr>
                </tbody>
            </table>

        </div>

        <div class="container-fluid fs-5" style="padding-left: 2%;">

            <div class="row">
            
                <div class="col-sm-8" style="padding-left: 5%; padding-right: 5%;">
                    <div class="row">
                        <div class="col-sm-4">
                            <div class="input-group">
                                <span class="input-group-text">Puntuación</span>
                                <input type="number" min="0" max="10" class="form-control" id="puntuacion" maxlength="2" size="2">
                                <button id="boton" class="btn btn-outline-secondary" type="button" onclick="incluirPuntuacion()">Añadir</button>
                            </div>
                        </div>
                        <div class="col-sm-8">
                            <textarea style="white-space: pre-line;" class="form-control" id="listaPuntuaciones" rows="10" readonly></textarea>
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="col-sm-8">
                    <div class="input-group">
                        <span class="input-group-text fw-bold">Cantidad de 9 </span>
                        <span class="input-group-text" id="nueves"> 0 </span>
                    </div>
                    <br/>
                    <div class="input-group">
                        <span class="input-group-text fw-bold">Cantidad de 10</span>
                        <span class="input-group-text" id="dieces"> 0 </span>
                    </div>
                    <br/>
                    <br/>
                    <br/>
                    <div class="input-group">
                        <span class="input-group-text fw-bold">Puntuacion total</span>
                        <span class="input-group-text" id="total"> 0 </span>
                    </div>
                </div>
                </div>
            </div>
        </div>

	</body>
</html>